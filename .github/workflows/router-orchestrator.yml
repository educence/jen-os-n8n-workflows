name: Router Orchestrator

# Runs every 5 minutes to check for PENDING tasks
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  process-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Query PENDING Tasks from Notion
        id: query
        run: |
          RESPONSE=$(curl -s -X POST 'https://api.notion.com/v1/databases/${{ secrets.NOTION_ROUTER_DB_ID }}/query' \
            -H 'Authorization: Bearer ${{ secrets.NOTION_API_KEY }}' \
            -H 'Notion-Version: 2022-06-28' \
            -H 'Content-Type: application/json' \
            -d '{
              "filter": {
                "property": "Status",
                "select": {
                  "equals": "PENDING"
                }
              },
              "page_size": 1
            }')
          
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check if there are results
          HAS_RESULTS=$(echo "$RESPONSE" | jq -r '.results | length')
          echo "has_results=$HAS_RESULTS" >> $GITHUB_OUTPUT

      - name: Process Task
        if: steps.query.outputs.has_results != '0'
        id: process
        run: |
          # Extract task details
          PAGE_ID=$(echo '${{ steps.query.outputs.response }}' | jq -r '.results[0].id')
          TASK_ID=$(echo '${{ steps.query.outputs.response }}' | jq -r '.results[0].properties["Task ID"].title[0].plain_text // "unknown"')
          PAYLOAD=$(echo '${{ steps.query.outputs.response }}' | jq -r '.results[0].properties.Payload.rich_text[0].plain_text // "{}"')
          TASK_TYPE=$(echo '${{ steps.query.outputs.response }}' | jq -r '.results[0].properties.Type.select.name // "QUERY"')
          TARGET=$(echo '${{ steps.query.outputs.response }}' | jq -r '.results[0].properties.Target.select.name // "Artifacts"')
          
          echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          
          # Mark as CLAIMED
          curl -s -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
            -H 'Authorization: Bearer ${{ secrets.NOTION_API_KEY }}' \
            -H 'Notion-Version: 2022-06-28' \
            -H 'Content-Type: application/json' \
            -d '{
              "properties": {
                "Status": {"select": {"name": "CLAIMED"}},
                "Executed By": {"rich_text": [{"text": {"content": "github-actions"}}]}
              }
            }'
          
          # Build prompt for Claude
          PROMPT="You are the Jen OS Assembler. Process this task and return ONLY the result, no explanations.\n\nTask ID: $TASK_ID\nType: $TASK_TYPE\nTarget: $TARGET\nPayload: $PAYLOAD\n\nExecute the task and return the output."
          
          # Call Claude API
          CLAUDE_RESPONSE=$(curl -s -X POST 'https://api.anthropic.com/v1/messages' \
            -H 'x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}' \
            -H 'anthropic-version: 2023-06-01' \
            -H 'Content-Type: application/json' \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [
                {\"role\": \"user\", \"content\": \"$PROMPT\"}
              ]
            }")
          
          # Extract response text
          RESULT=$(echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text // "Error processing task"')
          
          # Escape for JSON
          RESULT_ESCAPED=$(echo "$RESULT" | jq -Rs .)
          
          echo "result=$RESULT_ESCAPED" >> $GITHUB_OUTPUT

      - name: Update Task with Result
        if: steps.query.outputs.has_results != '0'
        run: |
          PAGE_ID="${{ steps.process.outputs.page_id }}"
          RESULT=${{ steps.process.outputs.result }}
          
          # Update with result and mark DONE
          curl -s -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
            -H 'Authorization: Bearer ${{ secrets.NOTION_API_KEY }}' \
            -H 'Notion-Version: 2022-06-28' \
            -H 'Content-Type: application/json' \
            -d "{
              \"properties\": {
                \"Status\": {\"select\": {\"name\": \"DONE\"}},
                \"Execution Notes\": {\"rich_text\": [{\"text\": {\"content\": $RESULT}}]}
              }
            }"
          
          echo "âœ… Task ${{ steps.process.outputs.task_id }} completed"

      - name: No Tasks
        if: steps.query.outputs.has_results == '0'
        run: echo "No PENDING tasks found"
